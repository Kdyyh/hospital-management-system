# 医院系统API测试结果汇总文档

## 📊 总体测试概况

- **测试时间**: 2025-08-29T22:34:05.626654
- **总API端点数**: 31个
- **总测试次数**: 90次
- **成功测试**: 84次
- **成功率**: 93.3%

### 各用户角色测试统计
- **admin**: 22/22 (100.0%)
- **core**: 22/22 (100.0%)  
- **super**: 23/23 (100.0%)
- **patient**: 17/23 (73.9%)

## 🔐 认证模块API

### 1. 用户登录
- **端点**: `POST /api/auth/login`
- **描述**: 用户登录认证
- **适用角色**: 所有用户
- **请求参数**:
  - `username` 或 `account` (必填): 用户名
  - `password` 或 `pwd` (必填): 密码
- **响应数据**:
  ```json
  {
    "ok": true,
    "token": "DRF Token认证令牌",
    "jwt_access": "JWT访问令牌",
    "jwt_refresh": "JWT刷新令牌", 
    "role": "用户角色",
    "user": {
      "id": 用户ID,
      "username": "用户名",
      "name": "用户姓名",
      "role": "用户角色"
    },
    "expires_in": 7200
  }
  ```
- **状态**: ✅ 100% 成功

### 2. 用户注册
- **端点**: `POST /api/user/register`
- **描述**: 注册新用户账号
- **适用角色**: 所有用户（无需认证）
- **请求参数**:
  - `username` (必填): 用户名
  - `password` (必填): 密码
  - `email` (必填): 邮箱地址
  - `phone` (必填): 手机号码
- **响应数据**: 用户注册成功信息
- **状态**: ✅ 100% 成功 (201 Created)

### 3. 患者注册
- **端点**: `POST /api/patient/register`
- **描述**: 注册新患者信息
- **适用角色**: 所有用户（无需认证）
- **请求参数**:
  - `name` (必填): 患者姓名
  - `phone` (必填): 手机号码
  - `id_card` (必填): 身份证号
  - `gender` (必填): 性别 (male/female)
  - `age` (必填): 年龄
- **响应数据**: 患者注册成功信息
- **状态**: ✅ 100% 成功 (201 Created)

### 4. 用户登出
- **端点**: `POST /api/auth/logout`
- **描述**: 用户登出系统
- **适用角色**: 所有用户（需要认证）
- **请求参数**: 
  - `refresh` (可选): 指定要注销的refresh token
- **响应数据**:
  ```json
  {"ok": true, "blacklisted": 注销的token数量}
  ```
- **状态**: ✅ 100% 成功

### 5. Token刷新
- **端点**: `POST /api/auth/refresh`
- **描述**: 刷新JWT访问令牌
- **适用角色**: 所有用户（需要有效的refresh token）
- **请求参数**:
  - `refresh` (必填): refresh token
- **响应数据**:
  ```json
  {
    "jwt_access": "新的访问令牌"
  }
  ```
- **状态**: ✅ 需要有效refresh token

### 6. 微信登录
- **端点**: `POST /api/auth/wx-login`
- **描述**: 微信一键登录
- **适用角色**: 所有用户
- **请求参数**:
  - `code` (必填): 微信登录code
- **响应数据**:
  ```json
  {
    "ok": true,
    "isNew": "是否是新用户",
    "need_profile_completion": "是否需要完善资料",
    "token": "认证token",
    "jwt_access": "JWT访问令牌",
    "jwt_refresh": "JWT刷新令牌",
    "role": "用户角色",
    "user": {用户信息}
  }
  ```
- **状态**: ⚠️ 需要配置微信小程序信息

### 7. 微信绑定手机
- **端点**: `POST /api/auth/wx-bind-phone`
- **描述**: 微信用户绑定手机号
- **适用角色**: 已认证用户
- **请求参数**:
  - `encryptedData` (必填): 加密数据
  - `iv` (必填): 加密算法的初始向量
- **响应数据**:
  ```json
  {"ok": true, "phone": "绑定的手机号"}
  ```
- **状态**: ⚠️ 需要微信登录且已绑定

### 8. 微信完善资料
- **端点**: `POST /api/auth/wx-complete-profile`
- **描述**: 微信用户完善个人资料
- **适用角色**: 已认证用户
- **请求参数**:
  - `name` (必填): 姓名
  - `sex` (必填): 性别
  - `age` (必填): 年龄
  - `phone` (可选): 手机号
- **响应数据**:
  ```json
  {"ok": true}
  ```
- **状态**: ⚠️ 需要微信登录且已绑定

## 🏥 患者管理API

### 9. 患者列表
- **端点**: `GET /api/patients`
- **描述**: 获取患者列表
- **适用角色**: admin, core, super
- **权限控制**: ❌ patient用户无权限
- **请求参数**: 无
- **响应数据**: 患者列表数组
- **状态**: ✅ 75% 成功（权限控制正确）

## 📋 科室管理API

### 10. 科室列表
- **端点**: `GET /api/departments`
- **描述**: 获取所有科室列表
- **适用角色**: 所有用户
- **请求参数**: 无
- **响应数据**: 科室列表数组
- **状态**: ✅ 100% 成功

### 11. 科室成员
- **端点**: `GET /api/departments/members`
- **描述**: 获取科室成员列表
- **适用角色**: 所有用户
- **请求参数**: 无
- **响应数据**: 科室成员列表
- **状态**: ✅ 100% 成功

### 12. 科室管理员
- **端点**: `GET /api/departments/admins`
- **描述**: 获取科室管理员列表
- **适用角色**: admin, core, super
- **权限控制**: ❌ patient用户无权限
- **请求参数**: 无
- **响应数据**: 管理员列表
- **状态**: ✅ 75% 成功（权限控制正确）

## 📊 队列管理API

### 13. 队列状态
- **端点**: `GET /api/queue/status`
- **描述**: 获取队列当前状态
- **适用角色**: 所有用户
- **请求参数**: 无
- **响应数据**: 队列状态信息
- **状态**: ✅ 100% 成功

### 14. 管理队列
- **端点**: `GET /api/admin/queue/list`
- **描述**: 获取管理视角的队列列表
- **适用角色**: admin, core, super
- **权限控制**: ❌ patient用户无权限
- **请求参数**: 无
- **响应数据**: 管理队列列表
- **状态**: ✅ 75% 成功（权限控制正确）

### 15. 队列统计
- **端点**: `GET /api/admin/queue/stats`
- **描述**: 获取队列统计信息
- **适用角色**: admin, core, super
- **权限控制**: ❌ patient用户无权限
- **请求参数**: 极
